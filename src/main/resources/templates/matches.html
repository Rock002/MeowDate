<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">
<head>
  <title>–ú—ç—Ç—á–∏</title>

  <th:block layout:fragment="styles">
    <style>
      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
      .matches-container {
          max-width: 800px;
          margin: 0 auto;
      }

      /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
      .page-title {
          font-size: 28px;
          margin-bottom: 10px;
          color: #333;
      }

      .page-subtitle {
          color: #666;
          margin-bottom: 30px;
          font-size: 16px;
      }

      /* –°–ø–∏—Å–æ–∫ –º—ç—Ç—á–µ–π */
      .matches-list {
          display: flex;
          flex-direction: column;
          gap: 20px;
      }

      /* –ö–∞—Ä—Ç–æ—á–∫–∞ –º—ç—Ç—á–∞ */
      .match-card {
          background: white;
          border: 1px solid #e0e0e0;
          border-radius: 10px;
          padding: 20px;
          display: flex;
          align-items: center;
          gap: 20px;
          transition: transform 0.2s, box-shadow 0.2s;
      }

      .match-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      /* –ê–≤–∞—Ç–∞—Ä –≤ –º—ç—Ç—á–µ */
      .match-avatar {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          object-fit: cover;
          background: #f5f5f5;
          flex-shrink: 0;
      }

      .no-avatar {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 28px;
          flex-shrink: 0;
      }

      /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º—ç—Ç—á–µ */
      .match-info {
          flex: 1;
      }

      .match-username {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 5px;
          color: #333;
      }

      .match-details {
          color: #666;
          font-size: 14px;
          margin-bottom: 10px;
          display: flex;
          flex-wrap: wrap;
          gap: 15px;
      }

      .match-details span {
          display: inline-flex;
          align-items: center;
          gap: 5px;
      }

      .match-bio {
          color: #777;
          font-size: 14px;
          line-height: 1.4;
          margin-top: 5px;
      }

      .match-date {
          color: #999;
          font-size: 12px;
          margin-top: 5px;
      }

      /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
      .match-actions {
          display: flex;
          flex-direction: column;
          gap: 10px;
          min-width: 150px;
      }

      .action-btn {
          padding: 10px 15px;
          border: none;
          border-radius: 6px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.2s;
          text-align: center;
          text-decoration: none;
          display: block;
      }

      .chat-btn {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .chat-btn:hover {
          background: linear-gradient(135deg, #5a6fd8 0%, #6a4090 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      }

      .unmatch-btn {
          background: #f8f9fa;
          color: #666;
          border: 1px solid #e0e0e0;
      }

      .unmatch-btn:hover {
          background: #e9ecef;
          color: #333;
      }

      /* –ï—Å–ª–∏ –º—ç—Ç—á–µ–π –Ω–µ—Ç */
      .empty-state {
          text-align: center;
          padding: 60px 20px;
          background: white;
          border-radius: 10px;
          border: 1px solid #e0e0e0;
          margin-top: 20px;
      }

      .empty-icon {
          font-size: 64px;
          margin-bottom: 20px;
          opacity: 0.3;
      }

      .empty-title {
          font-size: 22px;
          color: #333;
          margin-bottom: 10px;
      }

      .empty-description {
          color: #666;
          margin-bottom: 30px;
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          line-height: 1.5;
      }

      .action-link {
          display: inline-block;
          background: #333;
          color: white;
          padding: 12px 30px;
          border-radius: 6px;
          text-decoration: none;
          font-size: 16px;
      }

      .action-link:hover {
          background: #444;
      }

      /* –°—á–µ—Ç—á–∏–∫ –º—ç—Ç—á–µ–π */
      .matches-count {
          display: inline-block;
          background: #e91e63;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 14px;
          margin-left: 10px;
          vertical-align: middle;
      }

      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
      @media (max-width: 768px) {
          .match-card {
              flex-direction: column;
              text-align: center;
              padding: 15px;
          }

          .match-info {
              text-align: center;
          }

          .match-details {
              justify-content: center;
          }

          .match-actions {
              width: 100%;
              margin-top: 15px;
          }

          .action-btn {
              width: 100%;
          }
      }
    </style>
  </th:block>
</head>
<body>
<th:block layout:fragment="content">
  <div class="matches-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="page-title">
      –í–∞—à–∏ –º—ç—Ç—á–∏
      <span class="matches-count" th:text="${matches != null ? matches.size() : 0}">0</span>
    </h1>
    <p class="page-subtitle">–õ—é–¥–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —É –≤–∞—Å –≤–∑–∞–∏–º–Ω–∞—è —Å–∏–º–ø–∞—Ç–∏—è üíï</p>

    <!-- –°–ø–∏—Å–æ–∫ –º—ç—Ç—á–µ–π -->
    <div th:if="${matches != null && !matches.isEmpty()}">
      <div class="matches-list">
        <div class="match-card" th:each="match : ${matches}">
          <!-- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º—ç—Ç—á–µ -->
          <div th:with="otherUser=${matchService.getOtherUserInMatch(match, currentUser)}">

            <!-- –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div th:if="${otherUser.photos != null && !otherUser.photos.isEmpty()}">
              <img th:src="@{/{id}(id=${otherUser.photos[0].id})}"
                   th:alt="${otherUser.username}"
                   class="match-avatar">
            </div>
            <div th:unless="${otherUser.photos != null && !otherUser.photos.isEmpty()}">
              <div class="no-avatar">
                <span th:text="${otherUser.username.substring(0, 1).toUpperCase()}"></span>
              </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="match-info">
              <div class="match-username" th:text="${otherUser.username}"></div>

              <div class="match-details">
                                    <span th:if="${otherUser.userProfile != null && otherUser.userProfile.sex != null}">
                                        <span th:text="${otherUser.userProfile.sex}"></span>
                                    </span>

                <span th:if="${otherUser.userProfile != null && otherUser.userProfile.birthDate != null}">
                                        –í–æ–∑—Ä–∞—Å—Ç: <span th:text="${#temporals.year(#temporals.createNow()) - #temporals.year(otherUser.userProfile.birthDate)}"></span>
                                    </span>

                <span th:if="${otherUser.userProfile != null && otherUser.userProfile.location != null}">
                                        üìç <span th:text="${otherUser.userProfile.location}"></span>
                                    </span>
              </div>

              <div class="match-bio" th:if="${otherUser.userProfile != null && otherUser.userProfile.info != null}"
                   th:text="${otherUser.userProfile.info}">
              </div>

              <div class="match-date">
                –ú—ç—Ç—á —Å–æ–∑–¥–∞–Ω:
                <span th:text="${#temporals.format(match.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
              </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="match-actions">
              <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞) -->
              <a th:href="@{/chats/{id}(id=${otherUser.id})}" class="action-btn chat-btn">
                üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
              </a>

              <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º—ç—Ç—á–∞ -->
              <button class="action-btn unmatch-btn"
                      th:onclick="'unmatch(' + ${match.id} + ')'">
                ‚úï –£–¥–∞–ª–∏—Ç—å –º—ç—Ç—á
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ï—Å–ª–∏ –º—ç—Ç—á–µ–π –Ω–µ—Ç -->
    <div th:if="${matches == null || matches.isEmpty()}" class="empty-state">
      <div class="empty-icon">ü§ù</div>
      <h2 class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç –º—ç—Ç—á–µ–π</h2>
      <p class="empty-description">
        –ú—ç—Ç—á–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –≤—ã –∏ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å—Ç–∞–≤–∏—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É –ª–∞–π–∫–∏.
        –ù–∞—á–Ω–∏—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!
      </p>
      <a th:href="@{/}" class="action-link">–ù–∞–π—Ç–∏ –∞–Ω–∫–µ—Ç—ã ‚Üí</a>
    </div>
  </div>
</th:block>

<th:block layout:fragment="scripts">
  <script>
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º—ç—Ç—á–∞
    function unmatch(matchId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º—ç—Ç—á?')) {
            fetch('/matches/' + matchId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ CSRF, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω
                    // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                }
            }).then(response => {
                if (response.ok) {
                    // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –º—ç—Ç—á–∞
                    const card = document.querySelector(`[data-match-id="${matchId}"]`);
                    if (card) {
                        card.style.opacity = '0.5';
                        setTimeout(() => card.remove(), 300);
                    }
                    showNotification('–ú—ç—Ç—á —É–¥–∞–ª–µ–Ω');
                    updateMatchesCount();
                } else {
                    response.text().then(error => {
                        showNotification('–û—à–∏–±–∫–∞: ' + error);
                    });
                }
            }).catch(error => {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º—ç—Ç—á–∞');
            });
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message) {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –º—ç—Ç—á–µ–π
    function updateMatchesCount() {
        const matchesList = document.querySelector('.matches-list');
        const countElement = document.querySelector('.matches-count');
        if (matchesList && countElement) {
            const matchCards = matchesList.querySelectorAll('.match-card');
            countElement.textContent = matchCards.length;
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –º—ç—Ç—á–µ–π
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.match-card');
        cards.forEach((card, index) => {
            // –ü–æ–ª—É—á–∞–µ–º ID –º—ç—Ç—á–∞ –∏–∑ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            const unmatchBtn = card.querySelector('.unmatch-btn');
            if (unmatchBtn) {
                const onclickAttr = unmatchBtn.getAttribute('onclick');
                const matchId = onclickAttr.match(/unmatch\((\d+)\)/)[1];
                card.setAttribute('data-match-id', matchId);
            }
        });
    });
  </script>
</th:block>
</body>
</html>